
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Agricultural Classification and Estimation Service (ACES)">
      
      
        <meta name="author" content="biplovbhandari">
      
      
        <link rel="canonical" href="https://servir.github.io/servir-aces/">
      
      
      
        <link rel="next" href="installation/">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>ACES Documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="css/timeago.css">
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aces-agricultural-classification-and-estimation-service" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="ACES Documentation" class="md-header__button md-logo" aria-label="ACES Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ACES Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/SERVIR/servir-aces" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="ACES Documentation" class="md-nav__button md-logo" aria-label="ACES Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ACES Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/SERVIR/servir-aces" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    <span class="md-ellipsis">
      Features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tutorial-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-aces-module" class="md-nav__link">
    <span class="md-ellipsis">
      Running the ACES Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uploading-predictions-to-gcp-and-gee" class="md-nav__link">
    <span class="md-ellipsis">
      Uploading Predictions to GCP and GEE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    <span class="md-ellipsis">
      Tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributing" class="md-nav__link">
    <span class="md-ellipsis">
      Contributing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#license" class="md-nav__link">
    <span class="md-ellipsis">
      License
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/SERVIR/servir-aces/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issue
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="data_processor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    data_processor module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="model_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    model_builder module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="model_trainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    model_trainer module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    metrics module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ee_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ee_utils module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="remote_sensing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    remote_sensing module
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    <span class="md-ellipsis">
      Features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tutorial-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-aces-module" class="md-nav__link">
    <span class="md-ellipsis">
      Running the ACES Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uploading-predictions-to-gcp-and-gee" class="md-nav__link">
    <span class="md-ellipsis">
      Uploading Predictions to GCP and GEE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    <span class="md-ellipsis">
      Tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributing" class="md-nav__link">
    <span class="md-ellipsis">
      Contributing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#license" class="md-nav__link">
    <span class="md-ellipsis">
      License
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="aces-agricultural-classification-and-estimation-service">ACES (Agricultural Classification and Estimation Service)<a class="headerlink" href="#aces-agricultural-classification-and-estimation-service" title="Permanent link">&para;</a></h1>
<p><a href="https://pypi.python.org/pypi/servir-aces"><img alt="image" src="https://img.shields.io/pypi/v/servir-aces.svg" /></a>
<a href="https://github.com/conda-forge/servir-aces-feedstock"><img alt="Conda Recipe" src="https://img.shields.io/badge/recipe-servir--aces-green.svg" /></a>
<a href="https://anaconda.org/conda-forge/servir-aces"><img alt="image" src="https://img.shields.io/conda/vn/conda-forge/servir-aces.svg" /></a>
<a href="https://anaconda.org/conda-forge/servir-aces"><img alt="Conda Downloads" src="https://img.shields.io/conda/dn/conda-forge/servir-aces.svg" /></a></p>
<p>ACES (Agricultural Classification and Estimation Service) is a Python module for generating training data and training machine learning models for remote sensing applications. It provides functionalities for data processing, data loading from Earth Engine, feature extraction, and model training.</p>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>servir-aces
</code></pre></div></td></tr></table></div>
<p>For saving model plot in TensorFlow/Keras, you need <code>pydot</code> and Graphviz. To install, <code>pydot</code>, run:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pydot
</code></pre></div></td></tr></table></div>
<p>The installation process for Graphviz varies depending on your operating system.</p>
<ul>
<li><strong>For macOS</strong>:\
You can install Graphviz using Homebrew. If you don't have Homebrew installed, you can get it from https://brew.sh Once Homebrew is installed, run the following command:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>brew<span class="w"> </span>install<span class="w"> </span>graphviz
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p><strong>For Windows</strong>:\
Download the installer from the Graphviz website (<a href="https://graphviz.gitlab.io/download/">Graphviz Download Page</a>), and follow the installation instructions. Make sure to add the path to the Graphviz bin folder to your systemâ€™s PATH environment variable.</p>
</li>
<li>
<p><strong>For Linux (Ubuntu/Debian)</strong>:\
You can install Graphviz using apt:</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>graphviz
</code></pre></div></td></tr></table></div>
<h2 id="features">Features<a class="headerlink" href="#features" title="Permanent link">&para;</a></h2>
<ul>
<li>Data loading and processing from Earth Engine.</li>
<li>Generation of training data for machine learning models.</li>
<li>Training and evaluation of machine learning models (DNN, CNN, UNET).</li>
<li>Inferences of the trained ML/DL models.</li>
<li>Support for remote sensing feature extraction.</li>
<li>Integration with Apache Beam for data processing.</li>
</ul>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h3>
<p>ACES relies on environment variables defined in a <code>.env</code> file to configure various aspects of the training process. You can find an example <code>.env</code> file named <a href="https://github.com/SERVIR/servir-aces/blob/main/.env.example"><code>.env.example</code></a>. Copy this file and rename it to <code>config.env</code> in your project directory. Edit the variables within <code>config.env</code> to suit your specific needs. You will need to change several environment settings before running. Below are explained some of the environment configuration.</p>
<h3 id="environment-configuration">Environment Configuration<a class="headerlink" href="#environment-configuration" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>BASEDIR (str)</strong>: The base directory for the project. This is the root directory where all project-related files and subdirectories reside. It serves as the root directory for other folders containing data, outputs, etc.</p>
</li>
<li>
<p><strong>DATADIR (str)</strong>: The directory for your data, and will be used to retrieve data necessary for training experiments. For this you can either specify the Google Cloud Storage (GCS) path starting with <code>gs://</code> or the path which can ben either an full absolute path or relative path to <code>BASEDIR</code>. This means, for example, the path to your data directory can be either <code>gs://aces-project/data</code> or the full absolute path as <code>/home/aces-project/data</code> or can be relative path to <code>BASEDIR</code>; so if <code>BASEDIR</code> is <code>/home/aces-project</code> and <code>DATADIR</code> is <code>data</code>, then the <code>DATADIR</code> is constructed as <code>/home/aces-project/data</code>. \
Then your training, testing, and validation dataset should be placed as sub-directory inside the <code>DATADIR</code> with sub-directory named as "training", "testing", and "validation" respectively. This means, from above example, if <code>DATADIR</code> is <code>gs://aces-project/data</code> or <code>/home/aces-project/data</code>, the training, testing, and validation dataset should be made available at <code>gs://aces-project/data/training</code> or <code>/home/aces-project/data/training</code>, <code>gs://aces-project/data/testing</code> or <code>/home/aces-project/data/testing</code>, and <code>gs://aces-project/data/validation</code> or <code>/home/aces-project/data/validation</code> respectively.</p>
</li>
<li>
<p><strong>OUTPUT_DIR (str)</strong>: This is the directory where all output files, such as trained models, evaluation results, model outpus, and other generated files during training, will be saved. Similar to <code>DATADIR</code> above, this can be either an absolute full path or a relative path to the <code>BASEDIR</code>. This means, for example, the path to your output directory can be either a full absolute path as <code>/home/aces-project/output</code> or can be relative path to <code>BASEDIR</code>; so if <code>BASEDIR</code> is <code>/home/aces-project</code> and <code>OUTPUT_DIR</code> is <code>data</code>, then the <code>OUTPUT_DIR</code> is constructed as <code>/home/aces-project/output</code>.</p>
</li>
<li>
<p><strong>MODEL_DIR_NAME (str)</strong>: This is the sub-directory inside the <code>OUTPUT_DIR</code> where the output of the trained model and other relevant files. The rationale behind the <code>MODEL_DIR_NAME</code> is to provide a versioning mechanism. So, for example, if you're training a DNN model with different <code>BATCH_SIZE</code> say 32 and 64, you could run those two experiments with a <code>MODEL_DIR_NAME</code> as <code>dnn_batch_32</code> and <code>dnn_batch_64</code>, which saves those two experiments under that sub-directory name inside the <code>OUTPUT_DIR</code>. \
<strong><em>Note: MODEL_DIR_NAME is used to construct the MODEL_DIR config parameter which can be accessed as config.MODEL_DIR.</em></strong></p>
</li>
<li>
<p><strong>MODEL_TYPE (str)</strong>: This variable defines the type of deep learning model you want to train The default is "unet". The available choices are "dnn", "unet", and "cnn".
<strong><em>Note current version does not expose all the model intracacies through the environment file but future version may include those depending on the need.</em></strong></p>
</li>
<li>
<p><strong>FEATURES (str)</strong>: This variable specifies the feature names used in your training data. Each feature should correspond to a band or channel in your data. The features can be either specified as a comma-separated string, newline-separated string, or newline-with-comma separated string.\
For example, <code>FEATURES</code> can be specified as comma-separated string as <code>FEATURES = "red_before, green_before, blue_before, nir_before, red_during, green_during, blue_during, nir_during"</code> or newline separated string as
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="na">FEATURES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="err">red_before</span>
<span class="w">  </span><span class="na">green_before</span>
<span class="w">  </span><span class="na">blue_before</span>
<span class="w">  </span><span class="na">nir_before</span>
<span class="w">  </span><span class="na">red_during</span>
<span class="w">  </span><span class="na">green_during</span>
<span class="w">  </span><span class="na">blue_during</span>
<span class="w">  </span><span class="na">nir_during&quot;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>  or newline-with-comma separated string as
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="na">FEATURES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="err">red_before,</span>
<span class="w">  </span><span class="na">green_before,</span>
<span class="w">  </span><span class="na">blue_before,</span>
<span class="w">  </span><span class="na">nir_before,</span>
<span class="w">  </span><span class="na">red_during,</span>
<span class="w">  </span><span class="na">green_during,</span>
<span class="w">  </span><span class="na">blue_during,</span>
<span class="w">  </span><span class="na">nir_during&quot;</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p><strong>LABELS (str)</strong>: This variable specifies the target labels used in the training process. Similar to <code>FEATURES</code> above, you can specify this as either a comma-separated string, newline-separated string, or newline-with-comma separated string.</p>
</li>
<li>
<p><strong>PATCH_SHAPE (tuple)</strong>: This variable specifies the shape of the single patch (WxH) used for training datasets. The number of channels are taken from <code>FEATURES</code>. This is useful for patch based algorithms like U-Net and CNN. This can be specified as a tuple of patch dimension. eg. <code>PATCH_SHAPE = (256, 256)</code></p>
</li>
<li>
<p><strong>TRAIN_SIZE, TEST_SIZE, VAL_SIZE (int)</strong>: These variables define the number of samples used for training, testing, and validation, respectively. This can be speficied as the integer number. For example, <code>TRAIN_SIZE = 8531</code>, <code>TEST_SIZE = 1222</code>, <code>VAL_SIZE = 2404</code>.</p>
</li>
<li>
<p><strong>OUT_CLASS_NUM (int)</strong>: This variable specifies the number of output classes in the classification model. This can be speficied as the integer number. For example, <code>OUT_CLASS_NUM = 5</code>.</p>
</li>
<li>
<p><strong>SCALE (int)</strong>: This variable specifies the scale in which the analysis take place. This can be specified as the integer number. For example, <code>SCALE = 10</code>.</p>
</li>
<li>
<p><strong>DROPOUT_RATE (float)</strong>: This variable specifies the dropout rate for the model. This should be specified as the float number between 0 and 1. For example, <code>DROPOUT_RATE = 0.2</code> Anything below zero would be set to 0 and anything above 1 would be set to 1. If not specified, the <code>DROPOUT_RATE</code> would be set to 0.</p>
</li>
<li>
<p><strong>LOSS (str)</strong>: This variable specifies the loss function used for model training. Learn more about the loss function <a href="https://keras.io/api/losses/">here</a>. Use the named representation of the loss function. For example, in order to use <code>keras.losses.CategoricalCrossentropy</code>, you should specify <code>"categorical_crossentropy"</code>.</p>
</li>
<li>
<p><strong>ACTIVATION_FN (str)</strong>: This variable specifies the activation function to be used for model training. Learn more about the activation function available <a href="https://keras.io/api/layers/activations/">here</a>. Use the named representation of the activation function. For example, in order to use <code>keras.activations.softmax</code>, you should specify <code>"softmax"</code>.</p>
</li>
<li>
<p><strong>OPTIMIZER (str)</strong>: This variable specifies the optimizer function to be used for model training. Learn more about the optimizer function available <a href="https://keras.io/api/optimizers/">here</a>. Use the named representation of the activation function. For example, in order to use <code>keras.optimizers.Adam</code>, you should specify <code>"adam"</code>. \
<strong><em>Note current implementation does not expose all the parameters of the LOSS, ACTIVATION, OPTIMIZER but future version may include those depending on the need.</em></strong></p>
</li>
<li>
<p><strong>MODEL_CHECKPOINT_NAME (str)</strong>: This variable specifies the name to be used for the model checkpoints. Learn more about the model checkpoints <a href="https://keras.io/api/callbacks/model_checkpoint/">here</a>. This helps save the Keras model at some frequency.</p>
</li>
<li>
<p><strong>CALLBACK_PARAMETER (str)</strong>: This variable specifies the call metric parameter that needs to be monitored. This is used as the monitor value in the ModelCheckPoint and EarlyStopping Callbacks. Learn more about callbacks <a href="https://keras.io/api/callbacks/">here</a>. If not specified, default value of <code>"val_loss"</code> is set.</p>
</li>
<li>
<p><strong>EARLY_STOPPING (bool)</strong>: This variable specifies whether to use EarlyStopping callback or not. Learn more about callbacks <a href="https://keras.io/api/callbacks/">here</a>. The default value is False. If <code>EARLY_STOPPING</code> is set to True, the parameter to monitor is the <code>CALLBACK_PARAMETER</code> set above, and the <code>patience</code> argument is set to 30% of the total epochs defined by <code>EPOCHS</code> configuration.</p>
</li>
</ul>
<h2 id="tutorial">Tutorial<a class="headerlink" href="#tutorial" title="Permanent link">&para;</a></h2>
<p><strong><em>Note: We have a Jupyter Notebook Colab example that you can use to run without having to worry too much about setting up locally. You can find the relevant notebook <a href="https://github.com/SERVIR/servir-aces/blob/main/notebook/Rice_Mapping_Bhutan_2021.ipynb">here</a>. Note, however, the resources especially GPU may not be fully available via Colab for unpaid version</em></strong></p>
<p>ACES relies on environment variables defined in a <code>.env</code> file to configure various aspects of the training process. You can find an example <code>.env</code> file named <a href="https://github.com/SERVIR/servir-aces/blob/main/.env.example"><code>.env.example</code></a>. Copy this file and rename it to <code>config.env</code> in your project directory. Edit the variables within <code>config.env</code> to suit your specific needs.</p>
<p><strong><em>Learn how to setup your <code>BASEDIR</code>, <code>DATADIR</code>, <code>OUTPUT_DIR</code> and <code>MODEL_DIR_NAME</code> from <a href="#usage">Usage</a> above.</em></strong></p>
<p>For quickly running this, we have already prepared and exported the training datasets. They can be found at the Google Cloud Storage and we will use gsutil to get the dataset in our workspace. The dataset has training, testing, and validation subdirectory. Let's start by downloading these datasets in our workspace. Follow this <a href="https://cloud.google.com/storage/docs/gsutil_install">link</a> to install gsutil.</p>
<p><em>Note: If you're looking to produce your own datasets, you can follow this <a href="https://colab.research.google.com/drive/1LCFLeSCu969wIW8TD68-j4hfIu7WiRIK?usp=sharing">notebook</a> which was used to produce these training, testing, and validation datasets provided here.</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>mkdir<span class="w"> </span>path/to/your/project/data
gsutil<span class="w"> </span>-m<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>gs://dl-book/chapter-1/dnn_planet_wo_indices/*<span class="w"> </span>path/to/your/project/data
</code></pre></div></td></tr></table></div>
<p>The parent folder (if you run <code>gsutil -m cp -r gs://dl-book/chapter-1/* DATADIR</code>) has several dataset inside it. We use <code>dnn_planet_wo_indices</code> here because it has lightweight data and would be much faster to run. If you want to test U-Net model, you can use <code>unet_256x256_planet_wo_indices</code> folder instead. Each of these have training, testing, and validation sub-folder inside them.</p>
<p>We need to change some more parameters for this tutorial. We need to change the <code>MODEL_TYPE</code>. The default is "unet", let's change it to "dnn" since we will be training using that model.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">MODEL_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dnn&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Next define the <code>FEATURES</code> and the <code>LABELS</code> variables. You can refer to the <a href="#usage">Usage</a> section above to learn more. But this dataset was prepared for the rice mapping application that uses before and during growing season information. So for this dataset here are <code>FEATURES</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">FEATURES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="err">red_before</span>
<span class="na">green_before</span>
<span class="na">blue_before</span>
<span class="na">nir_before</span>
<span class="na">red_during</span>
<span class="na">green_during</span>
<span class="na">blue_during</span>
<span class="na">nir_during&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Similarly, since the dataset has a single label, it is going to be as below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">LABELS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;class&quot;</span>
</code></pre></div></td></tr></table></div>
<p>In addition, the training sizes (<code>TRAIN_SIZE</code>, <code>TEST_SIZE</code>, and <code>VAL_SIZE</code>) needs to be changed. For this dataset, we know our size before hand. <code>aces</code> also provides handful of functions that we can use to calculate this. See this <a href="https://colab.research.google.com/drive/12WgDI3ptFZHmcfOw89fmPSsDwO-sXIUH?usp=sharing">notebook</a> to learn more about how to do it. You should also change the <code>SCALE</code>, <code>DROPOUT_RATE</code>, <code>BATCH_SIZE</code>, <code>EPOCHS</code>, <code>LOSS</code>, <code>ACTIVATION</code>, <code>OUT_CLASS_NUM</code>, <code>OPTIMIZER</code>, <code>MODEL_CHECKPOINT_NAME</code> information as below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">TRAIN_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">8531</span>
<span class="na">TEST_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1222</span>
<span class="na">VAL_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2404</span>
<span class="na">SCALE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10</span>
<span class="na">DROPOUT_RATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.2</span>
<span class="na">BATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">32</span>
<span class="na">EPOCHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">30</span>
<span class="na">LOSS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;categorical_crossentropy&quot;</span>
<span class="na">ACTIVATION_FN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;softmax&quot;</span>
<span class="na">OPTIMIZER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;adam&quot;</span>
<span class="na">OUT_CLASS_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">5</span>
<span class="na">MODEL_CHECKPOINT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;modelCheckpoint&quot;</span>
</code></pre></div></td></tr></table></div>
<p>These settings should be good enough to get started. To view the complete settings and what they meant, you can view them <a href="https://github.com/SERVIR/servir-aces/blob/main/.env.example">here</a>.</p>
<h3 id="tutorial-configuration">Tutorial Configuration<a class="headerlink" href="#tutorial-configuration" title="Permanent link">&para;</a></h3>
<p>Here's the example configuration file for running this tutorial (<code>config.env</code>)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">BASEDIR</span><span class="o">=</span><span class="s">&quot;/path/to/your/project&quot;</span>
<span class="na">DATADIR</span><span class="o">=</span><span class="s">&quot;data&quot;</span>
<span class="na">OUTPUT_DIR</span><span class="o">=</span><span class="s">&quot;output&quot;</span>
<span class="na">MODEL_DIR_NAME</span><span class="o">=</span><span class="s">&quot;dnn_v1&quot;</span>
<span class="na">MODEL_TYPE</span><span class="o">=</span><span class="s">&quot;dnn&quot;</span>
<span class="na">FEATURES</span><span class="o">=</span><span class="s">&quot;</span><span class="err">red_before</span>
<span class="na">green_before</span>
<span class="na">blue_before</span>
<span class="na">nir_before</span>
<span class="na">red_during</span>
<span class="na">green_during</span>
<span class="na">blue_during</span>
<span class="na">nir_during&quot;</span>
<span class="na">LABELS</span><span class="o">=</span><span class="s">&quot;class&quot;</span>
<span class="na">PATCH_SHAPE</span><span class="o">=</span><span class="s">(256, 256)</span>
<span class="na">TRAIN_SIZE</span><span class="o">=</span><span class="s">8531</span>
<span class="na">TEST_SIZE</span><span class="o">=</span><span class="s">1222</span>
<span class="na">VAL_SIZE</span><span class="o">=</span><span class="s">2404</span>
<span class="na">SCALE</span><span class="o">=</span><span class="s">10</span>
<span class="na">DROPOUT_RATE</span><span class="o">=</span><span class="s">0.2</span>
<span class="na">BATCH_SIZE</span><span class="o">=</span><span class="s">32</span>
<span class="na">EPOCHS</span><span class="o">=</span><span class="s">30</span>
<span class="na">LOSS</span><span class="o">=</span><span class="s">&quot;categorical_crossentropy&quot;</span>
<span class="na">ACTIVATION_FN</span><span class="o">=</span><span class="s">&quot;softmax&quot;</span>
<span class="na">OPTIMIZER</span><span class="o">=</span><span class="s">&quot;adam&quot;</span>
<span class="c1"># &quot;cropland_etc&quot;, &quot;rice&quot;, &quot;forest&quot;, &quot;urban&quot;, &quot;others_water_etc&quot;</span>
<span class="na">OUT_CLASS_NUM</span><span class="o">=</span><span class="s">5</span>
<span class="na">MODEL_CHECKPOINT_NAME</span><span class="o">=</span><span class="s">&quot;modelCheckpoint&quot;</span>
</code></pre></div></td></tr></table></div>
<h3 id="running-the-aces-module">Running the ACES Module<a class="headerlink" href="#running-the-aces-module" title="Permanent link">&para;</a></h3>
<p>After setting up your config.env file, you can use the ACES module as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aces.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aces.model_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelTrainer</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;config.env&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">ModelTrainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train_model</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Once the model training is complete, it will save the trained model, evaluation results, plots, and other relevant files on the <code>MODEL_DIR</code> (sub-folder named <code>MODEL_DIR_NAME</code> inside the <code>OUTPUT_DIR</code>).</p>
<h3 id="inference">Inference<a class="headerlink" href="#inference" title="Permanent link">&para;</a></h3>
<p>For inference, you would need to get the images in a right format. To export images in the right way, refer to this <a href="https://github.com/SERVIR/servir-aces/blob/main/notebook/export_image_for_prediction.ipynb">notebook</a>, but for this, we already have the images prepared in the right way. You can download them in a similar manner you downloaded the training datasets. Change the IMAGEDIR to your appropriate directory.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>mkdir<span class="w"> </span>IMAGEDIR
gsutil<span class="w"> </span>-m<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>gs://dl-book/chapter-1/images/*<span class="w"> </span>IMAGEDIR
</code></pre></div></td></tr></table></div>
<p>There are few more settings that needs to be changed before we run the predictions. They are:
- <strong>OUTPUT_NAME (str)</strong>: This is the name of the output prediction for GEE asset, locally (in TF Format) and gcs output (in TFRecord format).</p>
<ul>
<li>
<p><strong>GCS_PROJECT (str)</strong>: This is the name of the Google Cloud Project that will be used to push the output from GCS to GEE for the prediction.</p>
</li>
<li>
<p><strong>GCS_BUCKET (str)</strong>: This is the name of the Google Cloud Bucket that will be used to store your prediction and should be inside the <code>GCS_PROJECT</code>.</p>
</li>
<li>
<p><strong>EE_OUTPUT_ASSET (str)</strong>: This is the name of the variable that will be used as the output path to the asset in Google Earth Engine (GEE) that is used to push the predictions to.</p>
</li>
</ul>
<p>So in addition to the already defined variables above, these are the additional example configuration for the prediction in the configuration file (<code>config.env</code>).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">OUTPUT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;prediction_dnn_v1&quot;</span>
<span class="na">GCS_PROJECT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;your-gcs-project&quot;</span>
<span class="na">GCS_BUCKET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;your-bucket&quot;</span>
<span class="na">EE_OUTPUT_ASSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;your-gee-output-asset-path&quot;</span>
</code></pre></div></td></tr></table></div>
<p>You will have to run the configuration settings again for the new configuration to take place.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aces.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;config.env&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>We can then start constructing the actual path for the output file using the <code>OUTPUT_NAME</code> as, and print it to view.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">OUTPUT_IMAGE_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">MODEL_DIR</span> <span class="o">/</span> <span class="s2">&quot;prediction&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">OUTPUT_NAME</span><span class="si">}</span><span class="s2">.TFRecord&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OUTPUT_IMAGE_FILE: </span><span class="si">{</span><span class="n">OUTPUT_IMAGE_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Now let's get all the files inside the <code>IMAGEDIR</code>, and then separate out our actual image files and the JSON mixer file. The JSON mixer file inside the <code>IMAGEDIR</code> is generated when exporting images from GEE as TFRecords. This is a simple JSON file for defining the georeferencing of the patches.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>

<span class="n">image_files_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">IMAGEDIR</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tfrecord.gz&quot;</span><span class="p">):</span>
        <span class="n">image_files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="n">f</span>

<span class="c1"># Make sure the files are in the right order.</span>
<span class="n">image_files_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Next, we will load the trained model and look at the model summary. The trained model is stored within the trained-model subdirectory in the MODEL_DIR.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading model from </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">MODEL_DIR</span><span class="p">)</span><span class="si">}</span><span class="s2">/trained-model&quot;</span><span class="p">)</span>
<span class="n">this_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">MODEL_DIR</span><span class="p">)</span><span class="si">}</span><span class="s2">/trained-model&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">this_model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
<p>Now let's get the relevant info from the JSON mixer file.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jm</span><span class="p">:</span> <span class="n">mixer</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jm</span><span class="p">)</span>

<span class="c1"># Get relevant info from the JSON mixer file.</span>
<span class="n">patch_width</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">[</span><span class="s2">&quot;patchDimensions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">patch_height</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">[</span><span class="s2">&quot;patchDimensions&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">patches</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">[</span><span class="s2">&quot;totalPatches&quot;</span><span class="p">]</span>
<span class="n">patch_dimensions_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch_width</span> <span class="o">*</span> <span class="n">patch_height</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>Next let's create a TFDataset from our images as:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_image</span><span class="p">(</span><span class="n">example_proto</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">patch_dimensions_flat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">FEATURES</span>
    <span class="p">]</span>
    <span class="n">image_features_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example_proto</span><span class="p">,</span> <span class="n">image_features_dict</span><span class="p">)</span>


<span class="c1"># Create a dataset from the TFRecord file(s).</span>
<span class="n">image_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">image_files_list</span><span class="p">,</span> <span class="n">compression_type</span><span class="o">=</span><span class="s2">&quot;GZIP&quot;</span><span class="p">)</span>
<span class="n">image_dataset</span> <span class="o">=</span> <span class="n">image_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_image</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Break our long tensors into many little ones.</span>
<span class="n">image_dataset</span> <span class="o">=</span> <span class="n">image_dataset</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">features</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Turn the dictionary in each record into a tuple without a label.</span>
<span class="n">image_dataset</span> <span class="o">=</span> <span class="n">image_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">data_dict</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="p">)</span>
<span class="p">)</span>

<span class="n">image_dataset</span> <span class="o">=</span> <span class="n">image_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">patch_width</span> <span class="o">*</span> <span class="n">patch_height</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Finally, let's perform the prediction.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">this_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image_dataset</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;predictions shape: </span><span class="si">{</span><span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Now let's write this predictions on the file.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Create the target directory if it doesn&#39;t exist</span>
<span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_IMAGE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing predictions to </span><span class="si">{</span><span class="n">OUTPUT_IMAGE_FILE</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">OUTPUT_IMAGE_FILE</span><span class="p">)</span>

<span class="c1"># Every patch-worth of predictions we&quot;ll dump an example into the output</span>
<span class="c1"># file with a single feature that holds our predictions. Since our predictions</span>
<span class="c1"># are already in the order of the exported data, the patches we create here</span>
<span class="c1"># will also be in the right order.</span>
<span class="n">patch</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>

<span class="n">cur_patch</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prediction</span><span class="p">)))</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">patch</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span>


    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prediction.shape: </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">patch_width</span> <span class="o">*</span> <span class="n">patch_height</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_patch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done with patch &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur_patch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>

        <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span>
            <span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                <span class="s2">&quot;cropland_etc&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                <span class="s2">&quot;rice&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
                <span class="s2">&quot;forest&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">4</span><span class="p">])),</span>
                <span class="s2">&quot;others_etc&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
                    <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">patch</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Write the example to the file and clear our patch array so it&quot;s ready for</span>
        <span class="c1"># another batch of class ids</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
        <span class="n">cur_patch</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="uploading-predictions-to-gcp-and-gee">Uploading Predictions to GCP and GEE<a class="headerlink" href="#uploading-predictions-to-gcp-and-gee" title="Permanent link">&para;</a></h3>
<p>Now we have write the prediction to the <code>OUTPUT_IMAGE_FILE</code>. You can upload this to GEE for visualization. To do this, you will need to upload to GCP and then to GEE.</p>
<p>You can upload to GCP using gsutil. The <code>OUTPUT_GCS_PATH</code> can be any path inside the <code>GCS_BUCKET</code> (e.g. <code>OUTPUT_GCS_PATH = f"gs://{config.GCS_BUCKET}/{config.OUTPUT_NAME}.TFRecord"</code>)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>gsutil<span class="w"> </span>cp<span class="w"> </span><span class="s2">&quot;{OUTPUT_IMAGE_FILE}&quot;</span><span class="w"> </span><span class="s2">&quot;{OUTPUT_GCS_PATH}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Once the file is available on GCP, you can then upload to earthengine using <code>earthengine</code> command line. Learn more about earthengine command line tools options <a href="https://developers.google.com/earth-engine/guides/command_line">here</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>earthengine<span class="w"> </span>upload<span class="w"> </span>image<span class="w"> </span>--asset_id<span class="o">={</span>config.EE_OUTPUT_ASSET<span class="o">}</span>/<span class="o">{</span>config.OUTPUT_NAME<span class="o">}</span><span class="w"> </span>--pyramiding_policy<span class="o">=</span>mode<span class="w"> </span><span class="o">{</span>OUTPUT_GCS_PATH<span class="o">}</span><span class="w"> </span><span class="o">{</span>json_file<span class="o">}</span>
</code></pre></div></td></tr></table></div>
<p>Note: Since this requires to use GCP and enable billing, we have hosted the prediction in the GCP so you don't have to. To use this prediction from GCP and upload to GEE, first make sure you are authenticated to earthengine using (learn more <a href="https://developers.google.com/earth-engine/guides/auth">here</a> to use different authentication techniques):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>earthengine<span class="w"> </span>authenticate
</code></pre></div></td></tr></table></div>
<p>You may need to set your project in earthengine to configure a default user project to be used for all API calls using the following command (replace <code>my-project</code> with your own project name). Learn more about authentication <a href="https://developers.google.com/earth-engine/guides/auth">here</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>earthengine<span class="w"> </span>set_project<span class="w"> </span><span class="o">{</span>my-project<span class="o">}</span>
</code></pre></div></td></tr></table></div>
<p>After that, let's say you want to upload it to your GEE asset to path say with <code>config.EE_OUTPUT_ASSET</code> as <code>users/biplov/aces_test</code> and <code>config.OUTPUT_NAME</code> as <code>prediction_dnn_v1</code> (you can directly use <code>{config.EE_OUTPUT_ASSET}</code> and <code>{config.OUTPUT_NAME}</code> as shown above), then do:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>earthengine<span class="w"> </span>upload<span class="w"> </span>image<span class="w"> </span>--asset_id<span class="o">=</span>users/biplov/aces_test/prediction_dnn_v1<span class="w"> </span>--pyramiding_policy<span class="o">=</span>mode<span class="w"> </span>gs://dl-book/chapter-1/prediction/prediction_dnn_v1.TFRecord<span class="w"> </span>gs://dl-book/chapter-1/images/image_2021mixer.json
</code></pre></div></td></tr></table></div>
<p>This will give the message similar to below</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>Started<span class="w"> </span>upload<span class="w"> </span>task<span class="w"> </span>with<span class="w"> </span>ID:<span class="w"> </span>T3FMGOOXIXJKEAYXPS77MWDB
</code></pre></div></td></tr></table></div>
<p>You can then go to <a href="https://code.earthengine.google.com/">GEE</a> and check your <code>Tasks</code> tab to see that task with the given ID. Once complete, you can use this <a href="https://code.earthengine.google.com/98960bd93d59d4236ecc7da02bb95dbb">script</a> to visualize your result. You can replace the asset with your own.</p>
<p><strong><em>Note: The inferencing is also available on this <a href="https://github.com/SERVIR/servir-aces/blob/main/notebook/Rice_Mapping_Bhutan_2021.ipynb">notebook</a>, scroll to <code>Inference using Saved U-Net Model</code> or <code>Inference using Saved DNN Model</code> depending upon which model you're using.</em></strong></p>
<h2 id="tests">Tests<a class="headerlink" href="#tests" title="Permanent link">&para;</a></h2>
<p>Several tests are provided in the <code>tests/</code> folder covering the functionality of the package. Install the testing environment with <a href="https://docs.pytest.org/en/"><code>pytest</code></a>: <code>pip install pytest</code>.</p>
<p>Then, run tests with pytest as:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="n">tests</span><span class="o">/</span>
</code></pre></div></td></tr></table></div>
<h2 id="contributing">Contributing<a class="headerlink" href="#contributing" title="Permanent link">&para;</a></h2>
<p>Contributions to ACES are welcome! If you find any issues or have suggestions for improvements, please open an issue or submit a pull request on the GitHub repository.</p>
<p>For Developers, to bump the version, refer <a href="https://github.com/opengeos/cookiecutter-pypackage">here</a>.</p>
<h2 id="license">License<a class="headerlink" href="#license" title="Permanent link">&para;</a></h2>
<p>This project is licensed under the <a href="https://github.com/SERVIR/servir-aces/blob/main/LICENSE">GNU General Public License v3.0</a>.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 4, 2025 16:18:28 UTC"><span class="timeago" datetime="2025-09-04T16:18:28+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 4, 2025 16:18:28 UTC">2025-09-04</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 4, 2025 16:18:28 UTC"><span class="timeago" datetime="2025-09-04T16:18:28+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 4, 2025 16:18:28 UTC">2025-09-04</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - 2024 SERVIR Global
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="js/timeago.min.js"></script>
      
        <script src="js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>